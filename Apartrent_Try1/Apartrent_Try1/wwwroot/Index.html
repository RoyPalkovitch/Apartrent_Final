<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ApartRent</title>
    <base href="inde    " />
    <!-- <script src="angular.min.js"></script>-->
    <!-- <script src="angular-route.min.js"></script>-->
    <script src="Angularjs.js"></script>
    <script src="angular-route.js"></script>
    <script src="AngularControllers/apartrentResultController.js"></script>
    <script src="AngularControllers/userProfileController.js"></script>
    <script src="AngularControllers/apartmentController.js"></script>
    <script src="AngularControllers/loginController.js"></script>
    <style>
        @import url('navbar.css');
        @import url('userdashboard.css');
        @import url('renterdashboard.css');
        @import url('orderbar.css');

        * {
            padding: 0;
            margin: 0;
        }

        body {
            width: 100%;
            height: 100%;
        }

        #searchApartment {
            width: 100%;
            height: 100%;
            position: absolute;
            background-image: url('IndexBackGround.jpg');
            background-repeat: no-repeat;
            color: white;
        }

        #searchWindow {
            width: 30%;
            bottom: 17%;
            right: 50%;
            background-color: white;
            opacity: 0.5;
            color: black;
            position: absolute;
            font-size: 20px;
            border-radius: 25px;
            border: 2px solid #73AD21;
            padding: 20px;
        }

            #searchWindow:hover {
                opacity: 1;
            }

        #countrySelect {
        }


        #errorMessage, #errorMessagebtn {
            position: relative;
            margin: 0;
        }
    </style>
</head>
<body>
    <div ng-app="apartrentApp">
        <div ng-controller="navBarController">
            <div ng-switch="role">

                <ul ng-switch-when="undefined" class="ulLoginRegisterBar">
                    <li id="liLoginRegisterBar" class="dropli">
                        <a ng-click="handelNavBarLogin() " class="dropbtn">Login</a>
                        <div class="Logindropdown-content" ng-show="showLogin">
                            User Name:<input class="loginInput" type="text" ng-model="$parent.loginUserName" />
                            <br />
                            Password:<input class="loginInput" type="password" ng-model="$parent.loginPassword" /><br />
                            <button ng-click="login()">Send</button>
                            <button ng-click="handelNavBarLogin()">exit</button>
                            <span id="errorLogin" ng-show="errorLoginDisplay">error somthing went wrong</span>

                        </div>
                    </li>
                    <li id="liLoginRegisterBar" class="dropli">
                        <a ng-click="handelNavBarRegister()" class="dropbtn">Register</a>
                        <div class="Logindropdown-content" ng-show="showRegister">

                            User Name:<input class="loginInput" type="text" ng-model="$parent.newUserName" />
                            <br />
                            Password:<input class="loginInput" type="password" ng-model="$parent.newPassword" /><br />
                            Gender:<select class="loginInput" ng-model="$parent.newGender">
                                <option value="true">Male</option>
                                <option value="false">Female</option>
                            </select>
                            <br />
                            Address:<input class="loginInput" type="text" ng-model="$parent.newAddress" /><br />
                            Phone Number:<input class="loginInput" type="tel" ng-model="$parent.newPhoneNumber" /><br />
                            Email:<input class="loginInput" type="email" ng-model="$parent.newEmail" /><br />
                            First Name:<input class="loginInput" type="text" ng-model="$parent.newFirstName" /><br />
                            Last Name:<input class="loginInput" type="text" ng-model="$parent.newLastName" /><br />
                            Country: <select class="loginInput" ng-model="$parent.newCountryID" required id="countrySelect">
                                <option ng-repeat="country in countries track by $index" ng-value="country.countryID">{{country.countryName}}</option>
                            </select>
                            <br />
                            <button ng-click="signUp()">SignUp</button>
                            <button ng-click="handelNavBarRegister()">exit</button>
                        </div>
                    </li>
                </ul>
                <ul ng-switch-when="0" class="ulLoginRegisterBar">
                    <li id="liLoginRegisterBar">
                        <a ng-href="yourProfile/{{user.userName}}.html" style="font-size:15px;">
                            <span ng-click="showYourProfile()">
                                Name:{{user.firstName}}
                                {{user.lastName}}
                                <br />User Name:{{user.userName}}
                            </span>
                        </a>
                    </li>

                    <li id="liLoginRegisterBar">
                        <a ng-href="yourProfile/{{user.userName}}/addApartment.html">
                            Join us Now and<br /> become a renter
                        </a>
                    </li>
                    <li id="liLoginRegisterBar">
                        <a><span ng-click="logout()" style="font-size:20px; height:100%;">Log Out</span></a>
                    </li>
                </ul>
                <ul ng-switch-when="1" class="ulLoginRegisterBar">
                    <li id="liLoginRegisterBar">
                        <a ng-href="yourProfile/{{user.userName}}.html" style="font-size:15px;">
                            <span ng-click="showYourProfile()">
                                Name:{{user.firstName}}
                                {{user.lastName}}
                                <br />User Name:{{user.userName}}
                            </span>
                        </a>
                        <a ng-href="yourProfile/{{user.userName}}/addApartment.html">
                            Add Apartment
                        </a>
                    </li>
                    <li id="liLoginRegisterBar">
                        <a><span ng-click="logout()">Log Out</span></a>
                    </li>
                </ul>
            </div>
        </div>
        <div ng-view></div>



    </div>  
    <script>
            var apartmentApp = angular.module('apartrentApp', ['ngRoute', 'apartrentResultController', 'userProfileController', 'apartmentController','loginController']);

        apartmentApp.config(function ($routeProvider, $locationProvider) {

            $routeProvider
                .when("/Index.html", {
                    templateUrl: "home.html", controller: "apartrentSearchController", resolve: {
                        UserLogin: function ($q) {
                            return $q.when();
                        }
                    }
                })

                .when("/", { templateUrl: "home.html" })
                .when("/index.html", { templateUrl: "home.html" })
                .when("/home.html", { templateUrl: "home.html" })

                .when("/searchResult/:id", {
                    templateUrl: "searchResult.html", controller: "apartrentResultController", resolve: {
                        searchResultBackend: function (apartmentsDataForLocationService) {
                            return apartmentsDataForLocationService.requestData();
                        }
                    }
                })
                .when("/searchResult/:id/viewApartment.html", {
                    templateUrl: "viewApartment.html", controller: "apartrentResultController", resolve: {
                        searchResultBackend: function (currentApartment) {
                            return currentApartment.requestData();
                        }
                    }
                })

                .when("/yourProfile/:id.html", {
                    templateUrl: "UserDashBoard/yourProfile.html", controller: "userProfileController", resolve:{
                        backendData: function ($q) {
                            return $q.when();
                        }
                    }
                })
                .when("/yourProfile/:id/editAccount.html", {
                    templateUrl: "UserDashBoard/editAccount.html", controller: "userProfileController", resolve: {
                        backendData: function ($q) {
                            return $q.when();
                        }
                    } })
                .when("/yourProfile/:id/becomeRenter.html", {
                    templateUrl: "UserDashBoard/becomeRenter.html", controller: "userProfileController", resolve: {
                        backendData: function ($q) {
                            return $q.when();
                        }
                    } })
                .when("/yourProfile/:id/myOrders.html", {
                    templateUrl: "UserDashBoard/myOrders.html", controller: "userProfileController", resolve: {
                        backendData: function ($http, userProfile) {
                            return $http.get("api/orders/UserOrders?userName=" + userProfile.data.userName + "&password=" + userProfile.data.password).then(function (response) {
                                if (response.data) {
                                    userProfile.data.orders = response.data;
                                    userProfile.getData();
                                }
                            });
                        }
                    }})
                .when("/yourProfile/:id/myReviews.html", {
                    templateUrl: "UserDashBoard/myReviews.html", controller: "userProfileController", resolve: {
                        backendData: function ($http, userProfile) {
                            return $http.get("api/reviews/UserReviews?userName=" + userProfile.data.userName + "&password=" + userProfile.data.password).then(function (response) {
                                if (response.data) {
                                    userProfile.data.reviews = response.data;
                                    userProfile.getData();
                                }
                            });
                        }
                    }
                })

                .when("/yourProfile/:id/addApartment.html", {
                    templateUrl: "RenterDashBoard/addApartment.html", controller: "apartmentController", resolve: {
                        currentApartmentData: function ($q) {
                            return $q.when();
                        }
                    }
                })
                .when("/yourProfile/:id/userApartments.html", {
                    templateUrl: "RenterDashBoard/userApartments.html", controller: "apartmentController", resolve: {
                        currentApartmentData: function ($q) {
                            return $q.when();
                        }
                    }
                })
                .when("/yourProfile/:id/editApartment.html", {
                    templateUrl: "RenterDashBoard/editApartment.html", controller: "apartmentController", resolve: {
                        currentApartmentData: function ($q) {
                            return $q.when();
                        }
                    }
                })
                .when("/yourProfile/:id/viewUserApartment.html", {
                    templateUrl: "RenterDashBoard/viewUserApartment.html", controller: "apartmentController", resolve: {
                        currentApartmentData: function (currentApartment) {
                            return currentApartment.requestData();
                        }
                    }
                })
                .when("/yourProfile/:id/userApartments/pendingOrders.html", {
                    templateUrl: "RenterDashBoard/pendingOrders.html", controller: "apartmentController" ,resolve: {
                        currentApartmentData: function ($http, userProfile) {
                            return $http.get("api/orders/PendingOrders?userName=" + userProfile.data.userName + "&password=" + userProfile.data.password).then(function (response) {
                                if (response.data) {
                                    userProfile.data.pendingOrders = response.data;
                                    userProfile.getData();
                                }
                            });
                        }
                    }
                })  


            $locationProvider.html5Mode({
                enabled: true,
                requireBase: false
            });
        });


        apartmentApp.run(function ($rootScope, $location, $route, userProfile, countriesService, $window) {
            $rootScope.$on('$locationChangeSuccess', function () { // caching location change

                if ($location.path() === $rootScope.oldLocation || $rootScope.oldLocation == '/Login.html')
                    userProfile.refreshData();
            });

            $rootScope.$watch(function () { return $location.path(); }, function (newLocation) { // watch if user change url
                if ($rootScope.oldLocation != newLocation) {
                    var caseParam = newLocation.split("/");

                    switch (caseParam[1]) { //change old location data and show the div that you supposed to see
                        case "":
                            $rootScope.searchHide = false;
                            $rootScope.viewProfile = true;
                            $rootScope.oldLocation = $location.path();

                            break;
                        case "searchResult":// need to call get data
                            $rootScope.searchHide = true;
                            $rootScope.viewProfile = true;
                            $rootScope.oldLocation = $location.path();
                            //apartmentsDataForLocationService.getApartmentsData();
                            countriesService.getData();
                            //if (caseParam[3] == "viewApartment.html")
                            //    currentApartment.getData();
                            break;
                        case "yourProfile":
                            $rootScope.searchHide = true;
                            $rootScope.viewProfile = false;
                            $rootScope.oldLocation = $location.path();
                            break;
                        default:
                            $rootScope.searchHide = false;
                            $rootScope.viewProfile = true;
                            $rootScope.oldLocation = $location.path();
                            break;

                    }
                }
            });

        });

        apartmentApp.factory("apartmentsDataForLocationService", function ($rootScope, $http) {
            var apartmentsData = {
                countryID : '',
                fromDate :'',
                toDate : '',
                numberOfGuests : ''
            };

            apartmentsData.data = '';
            apartmentsData.setApartmentsData = function (countryID, fromDate, toDate, numberOfGuests) {
                this.countryID = countryID;
                this.fromDate = fromDate;
                this.toDate = toDate;
                this.numberOfGuests = numberOfGuests;

            };

            apartmentsData.requestData = function () {
                return $http.get('api/apartment/ApartmentLocation?countryID=' + this.countryID + '&numberOfGuests=' + this.numberOfGuests + '&fromDate=' + this.fromDate.toDateString() + '&toDate=' + this.toDate.toDateString()).then(function (response) {
                    if (response.data) {
                        apartmentsData.data = response.data
                       // $rootScope.$broadcast('getApartmentsData');
                        return apartmentsData.data;
                    }
                });


            };

       

            apartmentsData.resetData = function () {
                apartmentsData = {};
            };
            return apartmentsData;

        }); // save the data gained from the server on the apartments client searched


        apartmentApp.factory("currentApartment", function ($rootScope, $http) {
            var apartmentsData = {
              apartmentID :'',
              fromDate:'',
              toDate:'',
              priceForStaying:'',
              pricePerDay :'',
              pricePerGuest :''
            };

            apartmentsData.data = '';

            apartmentsData.setData = function (data) {
                apartmentsData.apartmentID = data.apartmentID;
                apartmentsData.fromDate = data.fromDate;
                apartmentsData.toDate = data.toDate;
                apartmentsData.priceForStaying = data.priceForStaying;
                apartmentsData.pricePerDay = data.pricePerDay;
                apartmentsData.pricePerGuest = data.pricePerGuest;
                return;
            };

            apartmentsData.requestData = function () {
                return $http.get('api/apartment/GetApartment?apartmentID=' + this.apartmentID).then(function (response) {
                    if (response.data) {
                        apartmentsData.data = response.data;
                        apartmentsData.data.fromDate = apartmentsData.fromDate;
                        apartmentsData.data.toDate = apartmentsData.toDate;
                        apartmentsData.data.priceForStaying = apartmentsData.priceForStaying;
                        apartmentsData.data.pricePerDay = apartmentsData.pricePerDay;
                        apartmentsData.data.pricePerGuest = apartmentsData.pricePerGuest;
                        //$rootScope.$broadcast('getApartmentsData'); if everything work can be deleted
                        return apartmentsData.data;
                    }
                });
            };

           

            apartmentsData.resetData = function () {
                return apartmentsData = {};
            };
            return apartmentsData;
        });


        apartmentApp.factory("countriesService", function ($rootScope) {
            var countriesData = {};

            countriesData.data = '';

            countriesData.setData = function (data) {
                this.data = data;
                this.getData();
            };

            countriesData.getData = function () {
                $rootScope.$broadcast('getCountries');
            };

            countriesData.resetData = function () {
                countriesData.data = '';
            }
            return countriesData;


        });// save the countries data

        apartmentApp.factory("userProfile", function ($rootScope, $window) {
            var userProfile = {};
            userProfile.currentApartmentID = '';
            userProfile.data = '';

            userProfile.setData = function (data) {
               // $window.localStorage.removeItem('userProfile');
                this.data = data;
               // $window.localStorage.setItem('userProfile', JSON.stringify(userProfile));
                return this.getData();
            };

            userProfile.getData = function () {
                //$window.localStorage.setItem('userProfile', userProfile);
                $rootScope.$broadcast('getUserData');
            };

            userProfile.refreshData = function () {
                //userProfile = JSON.parse($window.localStorage.getItem('userProfile'));
                return this.getData();
            };

            userProfile.resetData = function () {
                this.setData('');
               // $window.localStorage.removeItem('userProfile');
            };
            return userProfile;

        });//will save the profile of the client

        apartmentApp.factory("categoriesFactory", function ($rootScope) {
            var categories = {};

            categories.data = '';
            categories.setData = function (data) {
                this.data = data;
                this.getData();
            };

            categories.getData = function () {
                $rootScope.$broadcast('getCategories');
            };



            categories.resetData = function () {
                categories.data = '';
            };

            return categories;
        });

        var date = new Date();//fetchin date object for today date

        apartmentApp.controller("navBarController", function ($scope, $http, $rootScope, countriesService, userProfile, $route, $location) {
           // ng - controller="navBarController"
            var navBar = this;
            navBar.reloadData = function () {
                $route.reload();
            }
           // $rootScope.role = -1; //change the view of navBar
            $scope.countries = [];

            $scope.showLogin = false;
            $scope.showRegister = false;

            $scope.loginUserName = "";
            $scope.loginPassword = "";

            $scope.user;


            $scope.$on("getUserData", function () {
                $scope.user = userProfile.data;
            });

            $scope.$on("getCountries", function () {
                $scope.countries = countriesService.data;
            });

            $scope.handelNavBarLogin = function () {//close and open login div making sure register is not open too
                if ($scope.showLogin) {
                    $scope.showLogin = !$scope.showLogin;
                    $scope.showRegister = false;
                    $scope.loginUserName = "";
                    $scope.loginPassword = "";
                    return;
                }
                $scope.loginUserName = "";
                $scope.loginPassword = "";
                $scope.showRegister = false;
                $scope.showLogin = true;

            };

            $scope.handelNavBarRegister = function () {//close and open register div making sure login is not open too
                if ($scope.showRegister) {
                    $scope.showRegister = !$scope.showRegister;
                    $scope.showLogin = false;
                    return;
                }
                $scope.showRegister = true;
                $scope.showLogin = false;

            };


            $scope.login = function () { //login vadilation through get request
                userProfile.resetData();
                $http.get('api/users/login?userName=' + $scope.loginUserName + '&password=' + $scope.loginPassword).then(function (response) {
                    if (response.data) {
                        userProfile.setData(response.data); //save data in factory
                        $scope.errorLoginDisplay = false;
                        userProfile.data.password = $scope.loginPassword;// all the userProfile will be in token for now i need to save the password like this
                        $scope.loginUserName = "";
                        $scope.loginPassword = "";
                        $scope.handelNavBarLogin();
                        return;
                    }
                    $scope.errorLoginDisplay = true;
                    return false;
                });

            };

            $scope.logout = function () {//logout function
                if ($rootScope.role != -1) //check if user role diffrent then -1 (loggedin)
                    userProfile.resetData();//remove user data
                $rootScope.role = -1;
                if (location.href.includes("yourProfile")) {//if user is in his profile he will redirect from there to index
                    window.location.href = "/Index.html";
                }

            };



            $scope.signUp = function () {
                $scope.newUser = { // new user object
                    userName: $scope.newUserName,
                    password: $scope.newPassword,
                    gender: $scope.newGender,
                    address: $scope.newAddress,
                    phoneNumber: $scope.newPhoneNumber,
                    email: $scope.newEmail,
                    firstName: $scope.newFirstName,
                    lastName: $scope.newLastName,
                    CountryID: $scope.newCountryID

                };
                $http.post('api/Users', $scope.newUser).then(function (response) {
                    if (response.data) { //post request for signup and clear the inputs
                        $scope.loginUserName = $scope.newUserName;
                        $scope.loginPassword = $scope.newPassword;
                        $scope.newUserName = '';
                        $scope.newPassword = '';
                        $scope.newGender = '';
                        $scope.newAddress = '';
                        $scope.newPhoneNumber = '';
                        $scope.newEmail = '';
                        $scope.newFirstName = '';
                        $scope.newLastName = '';
                        $scope.newCountryID = '';
                        $scope.login();//login the user
                    }
                });


            };
            $scope.showYourProfile = function () {
                //$rootScope.$emit("getYourUserProfile", []); // catching event every time you go to your profile to pass the data before loadin profile controller

                $rootScope.viewProfile = false;
                $rootScope.searchHide = true;

            };
        });




        apartmentApp.controller('apartrentSearchController', function ($scope, $rootScope, $http, $route, apartmentsDataForLocationService, countriesService, categoriesFactory, userProfile) {
            $scope.fromDate = new Date(date);//today date for search
            $scope.searchAndResultDiv = false;//show all the div
            $scope.errorMessage = '';//when somthing get wrong
            $scope.errorMessageDisplay = false;//if we should see the message

            $rootScope.searchHide = false;//if the search as worked

            $scope.searchButtonDisabled = false;//disabled the button so people wont spam it

            $scope.searchParams = [];//the parameters of the  search

            apartmentsDataForLocationService.resetData();//reset all saved apartments for search pattern
            // $scope.apartmentsDataForLocation = apartmentsDataForLocationService;//save the location service in local variable


            var apartmentSearch = this;
            apartmentSearch.reloadData = function () {
                $route.reload();
            };

            $scope.getCountries = function () {// get requrst to featch all the countries
                $http.get('api/countries').then(function (response) {
                    if (response.data) {
                        $scope.countries = response.data;
                        countriesService.setData($scope.countries);

                    }

                });
            };

            $scope.getCategories = function () {
                $http.get("api/apartment/ApartmentType").then(function (response) {
                    if (response) {
                        categoriesFactory.setData(response.data);
                    }
                });
            };

            $scope.getCountries();
            $scope.getCategories();

            $scope.searchApartment = function () {
                apartmentsDataForLocationService.setApartmentsData($scope.searchCountryID, $scope.searchAvailableFromDate, $scope.searchAvailableToDate, $scope.searchGuests)
            };

        });




    </script>
</body>
</html>